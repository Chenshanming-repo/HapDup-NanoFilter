# HapDup

HapDup (haplotype duplicator) is a pipeline to convert a haploid long-read assembly into a (pseudo-)diploid assembly.
The assembly preserves heterozygous structural variants (in addition to small variants) and
is phased within large (15 Mb+) blocks.


## Version 0.1

Quick start
-----------

The recommended way to run HapDup is the Docker distribution. If Docker is not installed
in your system, you need to set it up first following this [guide](https://docs.docker.com/engine/install/ubuntu/).

HapDup takes as input a long-read assembly, such as produced with [Flye](https://github.com/fenderglass/Flye) or 
[Shasta](https://github.com/chanzuckerberg/shasta). The first stage is to realign the original long reads
on the assembly using [minimap2](https://github.com/lh3/minimap2):

```
minimap2 -ax map-ont assembly.fasta reads.fastq | samtools sort -@ 4 -m 4G > lr_mapping.bam
samtools index -@ 4 assembly_lr_mapping.bam
```

Next steps assume that your `assembly.fasta` and `lr_mapping.bam` are in the same directory,
which will also be used for HapDup output. If it is not the case, you might need to bind additional 
directories using the Docker's `-v / --volume` argument. The number of threads (`-t` argument)
should be adjusted according to the available resources.

```
cd directory_with_assembly_and_alignment
HD_DIR=`pwd`
docker run -v $HD_DIR:$HD_DIR --ipc=host -u `id -u`:`id -g` mkolmogo/hap_dup:0.1 hap_dup --assembly $HD_DIR/assembly.fasta --bam $HD_DIR/lr_mapping.bam --out-dir $HD_DIR/hap_dup -t 64
```

Output files
------------

The output directory will contain:
* `haplotype_{1,2}.fasta` - final assembled haplotypes
* `phased_blocks_hp{1,2}.bed` - phased blocks coordinates

Haplotypes generated by the pipeline contain homozogous and heterozygous varinats (small and structural).
Becuase the pipeline is only using long-read (ONT) data, it does not achieve chromosome-level phasing.
Fully-phased blocks are given in the the `phased_blocks*` files.


Pipeline overview
-----------------

1. HapDup starts with filtering alignments that are likely originating from the unassembled parts of the genome.
Such alignments may later create false haplotypes if not removed (e.g. if reads from a segmental duplication with two copies
can create four haplotypes).

2. Afterwards, PEPPER is used to call SNPs from the filtered alignment file

3. Then we use Margin to phase SNPs and haplotype reads

4. We then use Flye to polish the initiall assembly with the reads from each of the two
haplotypes independently

5. Finally, we find (heterozygous) breakpoints in long-read alignments and apply
the corresponding structural changes to the corresponding polished haplotypes.
Currently, it allows to recover large heterozygous inversions.

Benchmarks
----------

[Section to be completed]

* SV evaluation on HG002 + other genomes?

* Yak evaluations

* Running time, memory usage

Source installation
-------------------

Here are the instructions to build a HapDup docker image locally.
To install directly into the system, please see `Dockerfile` for the command lines.

```
git clone https://github.com/fenderglass/HapDup
cd HapDup
git submodule update --init --recursive
docker build -t hap_dup .
```

Acknowledgements
----------------

The major parts of the HapDup pipeline are:

* [PEPPER](https://github.com/kishwarshafin/pepper)
* [Margin](https://github.com/UCSC-nanopore-cgl/margin)
* [Flye](https://github.com/fenderglass/Flye)


Authors
-------

The pipeline was developed at [UC Santa Cruz genomics institute](https://ucscgenomics.soe.ucsc.edu/), Benedict Paten's lab.

Main code contributors:
* Mikhail Kolmogorov

Citation
--------

If you use HapDap in your research, the most relevant papers to cite are:

Kishwar Shafin, Trevor Pesout, Pi-Chuan Chang, Maria Nattestad, Alexey Kolesnikov, Sidharth Goel, Gunjan Baid et al. 
"Haplotype-aware variant calling enables high accuracy in nanopore long-reads using deep neural networks." bioRxiv (2021).
[doi:10.1101/2021.03.04.433952](https://doi.org/10.1101/2021.03.04.433952)


Mikhail Kolmogorov, Jeffrey Yuan, Yu Lin and Pavel Pevzner, 
"Assembly of Long Error-Prone Reads Using Repeat Graphs", Nature Biotechnology, 2019
[doi:10.1038/s41587-019-0072-8](https://doi.org/10.1038/s41587-019-0072-8)

License
-------

HapDup is distributed under a BSD license. See the [LICENSE file](LICENSE) for details.
Other software included in this discrubution is released under either MIT or BSD licenses.


How to get help
---------------
A preferred way report any problems or ask questions is the 
[issue tracker](https://github.com/fenderglass/HapDup/issues). 

In case you prefer personal communication, please contact Mikhail at fenderglass@gmail.com.
